import { ImageResponse } from '@vercel/og'
import { NextApiRequest } from 'next'
import { passageReferenceSchema } from '~/lib/passageReference'

export const config = {
    runtime: 'edge',
}

async function createImage({ text }: { text: string }): Promise<ImageResponse> {
    // Make sure that this is not a variable font
    const fontData = await fetch(
        new URL('../../../public/Inter-SemiBold.ttf', import.meta.url),
    ).then(res => res.arrayBuffer())

    return new ImageResponse(
        (
            <div
                style={{
                    fontSize: 80,
                    color: 'black',
                    background: 'white',
                    width: '100%',
                    height: '100%',
                    padding: '50px 200px',
                    textAlign: 'center',
                    justifyContent: 'center',
                    alignItems: 'center',
                    display: 'flex',
                    fontFamily: '"Rethink"',
                }}
            >
                {text}
                <svg
                    width="380"
                    style={{
                        position: 'absolute',
                        right: '40px',
                        bottom: '40px',
                    }}
                    viewBox="0 0 102 19"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M4.836 14.0201H2.676V7.20414H0.18V5.44014H7.32V7.20414H4.836V14.0201ZM8.31675 16.1441C7.89675 16.1441 7.57275 16.1081 7.16475 16.0241V14.5601C7.36875 14.5841 7.52475 14.5961 7.74075 14.5961C8.11275 14.5961 8.65275 14.5841 8.82075 13.9361L6.37275 7.87614H8.35275L9.79275 11.9201H9.81675L11.1368 7.87614H13.0328L10.7888 14.0321C10.2728 15.4361 9.67275 16.1441 8.31675 16.1441ZM17.3027 7.68414C18.9347 7.68414 19.9787 8.93214 19.9787 10.9481C19.9787 12.9641 18.9347 14.2121 17.3027 14.2121C16.4147 14.2121 15.7667 13.7321 15.5267 13.4081H15.5027V16.1441H13.5827V7.87614H15.5027V8.48814H15.5267C15.7667 8.16414 16.4147 7.68414 17.3027 7.68414ZM16.7747 12.7721C17.5547 12.7721 18.0107 12.1481 18.0107 10.9481C18.0107 9.74814 17.5547 9.12414 16.7747 9.12414C15.9947 9.12414 15.5387 9.74814 15.5387 10.9481C15.5387 12.1481 15.9947 12.7721 16.7747 12.7721ZM26.8617 11.1761V11.4641H22.4457C22.4457 12.3161 23.0457 12.7841 23.7657 12.7841C24.4497 12.7841 24.7377 12.4721 24.8577 12.1601H26.8137C26.4657 13.4081 25.4457 14.2241 23.7177 14.2241C21.7257 14.2241 20.5257 12.8681 20.5257 10.9481C20.5257 9.14814 21.6537 7.67214 23.7177 7.67214C25.8057 7.67214 26.8617 8.90814 26.8617 11.1761ZM22.4577 10.2761H24.9297C24.9297 9.48414 24.4617 9.06414 23.7177 9.06414C22.9857 9.06414 22.5057 9.48414 22.4577 10.2761ZM32.9898 12.7001C33.1698 12.7001 33.2778 12.6881 33.5058 12.6521V14.0081C33.0978 14.1041 32.7498 14.1401 32.3658 14.1401C31.0218 14.1401 30.4458 13.5281 30.4458 12.0281V9.31614H29.5938V7.87614H30.4458V6.16014H32.3658V7.87614H33.4338V9.31614H32.3658V11.9801C32.3658 12.6401 32.6178 12.7001 32.9898 12.7001ZM38.2966 7.68414C39.4846 7.68414 40.2886 8.46414 40.2886 9.86814V14.0201H38.3686V10.4801C38.3686 9.55614 38.0446 9.24414 37.4086 9.24414C36.6766 9.24414 36.2566 9.61614 36.2566 10.4681V14.0201H34.3366V5.44014H36.2566V8.76414H36.2806C36.6046 8.20014 37.2046 7.68414 38.2966 7.68414Z"
                        fill="#535963"
                        fillOpacity="0.79"
                    />
                    <path
                        d="M47.2903 11.1761V11.4641H42.8743C42.8743 12.3161 43.4743 12.7841 44.1943 12.7841C44.8783 12.7841 45.1663 12.4721 45.2863 12.1601H47.2423C46.8943 13.4081 45.8743 14.2241 44.1463 14.2241C42.1543 14.2241 40.9543 12.8681 40.9543 10.9481C40.9543 9.14814 42.0823 7.67214 44.1463 7.67214C46.2343 7.67214 47.2903 8.90814 47.2903 11.1761ZM42.8863 10.2761H45.3583C45.3583 9.48414 44.8903 9.06414 44.1463 9.06414C43.4143 9.06414 42.9343 9.48414 42.8863 10.2761ZM53.5214 14.0201H51.3614L49.1774 5.44014H51.3374L52.4414 11.2601H52.4654L53.7974 5.44014H55.8374L57.1694 11.2601H57.1934L58.2974 5.44014H60.4574L58.2734 14.0201H56.1134L54.8294 8.66814H54.8054L53.5214 14.0201ZM63.2327 14.2241C61.2047 14.2241 59.9687 12.9041 59.9687 10.9601C59.9687 9.02814 61.2047 7.67214 63.2687 7.67214C65.2967 7.67214 66.5327 8.99214 66.5327 10.9241C66.5327 12.8681 65.2967 14.2241 63.2327 14.2241ZM63.2567 12.7841C64.1087 12.7841 64.5887 12.1361 64.5887 10.9481C64.5887 9.76014 64.1087 9.11214 63.2567 9.11214C62.3927 9.11214 61.9127 9.76014 61.9127 10.9481C61.9127 12.1361 62.3927 12.7841 63.2567 12.7841ZM70.5265 7.82814C70.6945 7.82814 70.8385 7.82814 71.0545 7.87614V9.55614C70.8985 9.53214 70.7905 9.52014 70.6585 9.52014C69.7945 9.52014 69.0025 10.0601 69.0025 11.1641V14.0201H67.0825V7.87614H69.0025V8.88414H69.0265C69.3265 8.23614 69.8545 7.82814 70.5265 7.82814ZM75.5197 8.48814V5.44014H77.4397V14.0201H75.5197V13.4081H75.4957C75.2557 13.7321 74.6077 14.2121 73.7197 14.2121C72.0877 14.2121 71.0437 12.9641 71.0437 10.9481C71.0437 8.93214 72.0877 7.68414 73.7197 7.68414C74.6077 7.68414 75.2557 8.16414 75.4957 8.48814H75.5197ZM74.2477 12.7721C75.0277 12.7721 75.4837 12.1481 75.4837 10.9481C75.4837 9.74814 75.0277 9.12414 74.2477 9.12414C73.4677 9.12414 73.0117 9.74814 73.0117 10.9481C73.0117 12.1481 73.4677 12.7721 74.2477 12.7721Z"
                        fill="black"
                    />
                    <path
                        d="M40.5 3.02009H41.5V17.0201H40.5V3.02009Z"
                        fill="black"
                    />
                    <path
                        d="M90.9767 3.18933V18.4955M93.1633 4.07922H98.6298M93.1633 6.39294H98.6298M93.1633 8.70667H98.6298M93.1633 11.0204H98.6298M93.1633 13.1561H98.6298M83.3236 4.07922H88.7901M83.3236 6.39294H88.7901M83.3236 8.70667H88.7901M83.3236 11.0204H88.7901M83.3236 13.1561H88.7901"
                        stroke="black"
                    />
                    <path
                        d="M81 16.1187V1.4104H88.7994C90.1053 1.4104 90.9759 1.94851 90.9759 3.20409C90.9759 1.94851 91.7014 1.4104 93.1525 1.4104H100.77V16.1187H93.1525C91.5201 16.1187 90.9759 17.733 90.9759 18.6298C90.9759 17.733 90.2504 16.1187 88.4366 16.1187H81Z"
                        stroke="black"
                    />
                </svg>
            </div>
        ),
        {
            width: 1200,
            height: 630,
            fonts: [
                {
                    name: 'Rethink',
                    data: fontData,
                    style: 'normal',
                },
            ],
        },
    )
}

export default async function handler(req: NextApiRequest) {
    const url = new URL(req.url ?? '', 'https://typetheword.site')
    const search = new URLSearchParams(url.search)

    if (search.has('path') && search.get('path') === 'history') {
        return createImage({ text: 'History' })
    } else if (search.has('path') && search.get('path') === 'why?') {
        return createImage({ text: 'Why type through the Bible?' })
    }

    if (search.has('passage')) {
        return createImage({
            text: passageReferenceSchema.parse(search.get('passage') ?? ''),
        })
    }

    return new ImageResponse(
        (
            <div
                style={{
                    fontSize: 40,
                    color: 'black',
                    background: 'white',
                    width: '100%',
                    height: '100%',
                    padding: '50px 200px',
                    textAlign: 'center',
                    justifyContent: 'center',
                    alignItems: 'center',
                    display: 'flex',
                }}
            >
                <svg
                    width="800"
                    viewBox="0 0 102 19"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        d="M4.836 14.0201H2.676V7.20414H0.18V5.44014H7.32V7.20414H4.836V14.0201ZM8.31675 16.1441C7.89675 16.1441 7.57275 16.1081 7.16475 16.0241V14.5601C7.36875 14.5841 7.52475 14.5961 7.74075 14.5961C8.11275 14.5961 8.65275 14.5841 8.82075 13.9361L6.37275 7.87614H8.35275L9.79275 11.9201H9.81675L11.1368 7.87614H13.0328L10.7888 14.0321C10.2728 15.4361 9.67275 16.1441 8.31675 16.1441ZM17.3027 7.68414C18.9347 7.68414 19.9787 8.93214 19.9787 10.9481C19.9787 12.9641 18.9347 14.2121 17.3027 14.2121C16.4147 14.2121 15.7667 13.7321 15.5267 13.4081H15.5027V16.1441H13.5827V7.87614H15.5027V8.48814H15.5267C15.7667 8.16414 16.4147 7.68414 17.3027 7.68414ZM16.7747 12.7721C17.5547 12.7721 18.0107 12.1481 18.0107 10.9481C18.0107 9.74814 17.5547 9.12414 16.7747 9.12414C15.9947 9.12414 15.5387 9.74814 15.5387 10.9481C15.5387 12.1481 15.9947 12.7721 16.7747 12.7721ZM26.8617 11.1761V11.4641H22.4457C22.4457 12.3161 23.0457 12.7841 23.7657 12.7841C24.4497 12.7841 24.7377 12.4721 24.8577 12.1601H26.8137C26.4657 13.4081 25.4457 14.2241 23.7177 14.2241C21.7257 14.2241 20.5257 12.8681 20.5257 10.9481C20.5257 9.14814 21.6537 7.67214 23.7177 7.67214C25.8057 7.67214 26.8617 8.90814 26.8617 11.1761ZM22.4577 10.2761H24.9297C24.9297 9.48414 24.4617 9.06414 23.7177 9.06414C22.9857 9.06414 22.5057 9.48414 22.4577 10.2761ZM32.9898 12.7001C33.1698 12.7001 33.2778 12.6881 33.5058 12.6521V14.0081C33.0978 14.1041 32.7498 14.1401 32.3658 14.1401C31.0218 14.1401 30.4458 13.5281 30.4458 12.0281V9.31614H29.5938V7.87614H30.4458V6.16014H32.3658V7.87614H33.4338V9.31614H32.3658V11.9801C32.3658 12.6401 32.6178 12.7001 32.9898 12.7001ZM38.2966 7.68414C39.4846 7.68414 40.2886 8.46414 40.2886 9.86814V14.0201H38.3686V10.4801C38.3686 9.55614 38.0446 9.24414 37.4086 9.24414C36.6766 9.24414 36.2566 9.61614 36.2566 10.4681V14.0201H34.3366V5.44014H36.2566V8.76414H36.2806C36.6046 8.20014 37.2046 7.68414 38.2966 7.68414Z"
                        fill="#535963"
                        fillOpacity="0.79"
                    />
                    <path
                        d="M47.2903 11.1761V11.4641H42.8743C42.8743 12.3161 43.4743 12.7841 44.1943 12.7841C44.8783 12.7841 45.1663 12.4721 45.2863 12.1601H47.2423C46.8943 13.4081 45.8743 14.2241 44.1463 14.2241C42.1543 14.2241 40.9543 12.8681 40.9543 10.9481C40.9543 9.14814 42.0823 7.67214 44.1463 7.67214C46.2343 7.67214 47.2903 8.90814 47.2903 11.1761ZM42.8863 10.2761H45.3583C45.3583 9.48414 44.8903 9.06414 44.1463 9.06414C43.4143 9.06414 42.9343 9.48414 42.8863 10.2761ZM53.5214 14.0201H51.3614L49.1774 5.44014H51.3374L52.4414 11.2601H52.4654L53.7974 5.44014H55.8374L57.1694 11.2601H57.1934L58.2974 5.44014H60.4574L58.2734 14.0201H56.1134L54.8294 8.66814H54.8054L53.5214 14.0201ZM63.2327 14.2241C61.2047 14.2241 59.9687 12.9041 59.9687 10.9601C59.9687 9.02814 61.2047 7.67214 63.2687 7.67214C65.2967 7.67214 66.5327 8.99214 66.5327 10.9241C66.5327 12.8681 65.2967 14.2241 63.2327 14.2241ZM63.2567 12.7841C64.1087 12.7841 64.5887 12.1361 64.5887 10.9481C64.5887 9.76014 64.1087 9.11214 63.2567 9.11214C62.3927 9.11214 61.9127 9.76014 61.9127 10.9481C61.9127 12.1361 62.3927 12.7841 63.2567 12.7841ZM70.5265 7.82814C70.6945 7.82814 70.8385 7.82814 71.0545 7.87614V9.55614C70.8985 9.53214 70.7905 9.52014 70.6585 9.52014C69.7945 9.52014 69.0025 10.0601 69.0025 11.1641V14.0201H67.0825V7.87614H69.0025V8.88414H69.0265C69.3265 8.23614 69.8545 7.82814 70.5265 7.82814ZM75.5197 8.48814V5.44014H77.4397V14.0201H75.5197V13.4081H75.4957C75.2557 13.7321 74.6077 14.2121 73.7197 14.2121C72.0877 14.2121 71.0437 12.9641 71.0437 10.9481C71.0437 8.93214 72.0877 7.68414 73.7197 7.68414C74.6077 7.68414 75.2557 8.16414 75.4957 8.48814H75.5197ZM74.2477 12.7721C75.0277 12.7721 75.4837 12.1481 75.4837 10.9481C75.4837 9.74814 75.0277 9.12414 74.2477 9.12414C73.4677 9.12414 73.0117 9.74814 73.0117 10.9481C73.0117 12.1481 73.4677 12.7721 74.2477 12.7721Z"
                        fill="black"
                    />
                    <path
                        d="M40.5 3.02009H41.5V17.0201H40.5V3.02009Z"
                        fill="black"
                    />
                    <path
                        d="M90.9767 3.18933V18.4955M93.1633 4.07922H98.6298M93.1633 6.39294H98.6298M93.1633 8.70667H98.6298M93.1633 11.0204H98.6298M93.1633 13.1561H98.6298M83.3236 4.07922H88.7901M83.3236 6.39294H88.7901M83.3236 8.70667H88.7901M83.3236 11.0204H88.7901M83.3236 13.1561H88.7901"
                        stroke="black"
                    />
                    <path
                        d="M81 16.1187V1.4104H88.7994C90.1053 1.4104 90.9759 1.94851 90.9759 3.20409C90.9759 1.94851 91.7014 1.4104 93.1525 1.4104H100.77V16.1187H93.1525C91.5201 16.1187 90.9759 17.733 90.9759 18.6298C90.9759 17.733 90.2504 16.1187 88.4366 16.1187H81Z"
                        stroke="black"
                    />
                </svg>
            </div>
        ),
        {
            width: 1200,
            height: 630,
        },
    )
}
