#!/usr/bin/env bash

set -euo pipefail

echo "ğŸ” Running pre-push checks..."
echo "ğŸ“± Running checks in parallel..."

FAILED=0

(
  echo "  ğŸ”§ Running Oxlint (type-aware linting)..."
  if ! just lint-check > /tmp/lint.log 2>&1; then
    echo "âŒ Linting failed! Run 'just lint' to auto-fix issues."
    cat /tmp/lint.log
    exit 1
  fi
  echo "  âœ… Linting passed"
) &
LINT_PID=$!

(
  echo "  ğŸ”§ Running TypeScript type checking..."
  if ! just type-check > /tmp/typecheck.log 2>&1; then
    echo "âŒ TypeScript type checking failed!"
    cat /tmp/typecheck.log
    exit 1
  fi
  echo "  âœ… Type checking passed"
) &
TYPECHECK_PID=$!

(
  echo "  ğŸ”§ Checking Oxfmt formatting..."
  if ! just format-check > /tmp/format.log 2>&1; then
    echo "âŒ Formatting check failed! Run 'just format' to fix."
    cat /tmp/format.log
    exit 1
  fi
  echo "  âœ… Formatting check passed"
) &
FORMAT_PID=$!

wait $LINT_PID || FAILED=1
wait $TYPECHECK_PID || FAILED=1
wait $FORMAT_PID || FAILED=1

if [ "$FAILED" -eq 1 ]; then
  exit 1
fi

echo "  ğŸ§ª Running tests..."
if ! just test; then
  echo "âŒ Tests failed!"
  exit 1
fi
echo "  âœ… Tests passed"

echo ""
echo "ğŸ‰ All pre-push checks passed!"
